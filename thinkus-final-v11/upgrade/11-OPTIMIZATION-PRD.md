# Thinkus 系统优化升级 - 产品需求文档

> **版本**: v1.0 | **日期**: 2026-01-15
>
> **定位**: 基于已有系统的增强优化，而非新功能开发
>
> **灵感来源**: oh-my-opencode 核心设计理念
>
> **核心目标**: 让AI真正"对结果负责"，而不只是"完成任务"

---

## 一、优化背景

### 1.1 已有系统能力回顾

```yaml
已完成设计的系统:
  ✅ 18个AI高管 (专业分工)
  ✅ Skills技能系统 (知识+流程+模板+最佳实践)
  ✅ Subagents并行协作 (任务分解+并行执行+结果汇总)
  ✅ MCP服务连接 (GitHub/Vercel/Stripe等)
  ✅ Browser自动化 (实时预览/自动测试/竞品分析)
  ✅ Auto-Verify闭环 (验证-修复自动循环)
  ✅ AI员工记忆系统 (Memory Controller/两阶段检索)
```

### 1.2 优化机会点

通过分析oh-my-opencode项目，发现以下可以增强已有系统的优化点：

```yaml
优化点1 - Magic Keyword (增强Subagents):
  当前: Subagents需要AI判断何时启用并行
  优化: 用户输入关键词即可触发全自动并行模式

优化点2 - Todo Continuation (增强Auto-Verify):
  当前: 验证通过即结束
  优化: 追踪所有TODO，未完成不允许结束

优化点3 - Comment Checker (增强代码质量):
  当前: 只验证代码是否能运行
  优化: 额外检查注释质量，让代码像人写的

优化点4 - Context Window Monitor (增强Memory系统):
  当前: 靠Memory Controller被动管理
  优化: 主动监控上下文，提前压缩避免撞墙

优化点5 - Session Recovery (增强稳定性):
  当前: 错误后需要人工干预
  优化: 自动从各种错误中恢复

优化点6 - Librarian Agent (增强AI高管):
  当前: 18个高管，缺少专门的研究员
  优化: 新增研究员角色，专门查文档和开源实现
```

---

## 二、优化项详细设计

### 2.1 [优化1] Magic Keyword 触发系统

#### 2.1.1 与现有系统的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  现有系统                           优化后                                  │
│  ─────────                          ─────────                               │
│                                                                              │
│  用户: "做一个电商网站"             用户: "做一个电商网站 全力"            │
│          │                                     │                            │
│          ▼                                     ▼                            │
│  Mike分析 → 决定是否并行            检测到"全力" → 自动启动全力模式         │
│          │                                     │                            │
│          ▼                                     ▼                            │
│  可能串行，可能并行                 一定并行 + 一定持续到完成               │
│  (AI自己判断)                       (用户意图明确)                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.1.2 关键词定义

```yaml
全力模式关键词:
  中文: 全力, 开工, 猛干, 冲, 加油干
  英文: ultrawork, ulw, fullpower, gogogo
  
  触发效果:
    1. 自动启用Subagents并行
    2. 自动启用Todo Continuation
    3. 自动启用Auto-Verify
    4. 所有高管进入"不完成不休息"模式

深度搜索关键词:
  中文: 搜索, 找, 查一下, 研究一下
  英文: search, find, research, lookup
  
  触发效果:
    1. 优先调用Librarian (研究员)
    2. 并行搜索官方文档+GitHub代码+网络

深度分析关键词:
  中文: 分析, 调研, 诊断, 评估
  英文: analyze, investigate, diagnose, evaluate
  
  触发效果:
    1. 多个高管并行分析
    2. 技术+设计+商业+市场多维度
    3. 生成综合报告
```

#### 2.1.3 用户体验

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  用户: "做一个类似Notion的笔记应用 全力"                                   │
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  🚀 检测到「全力」模式，已启动全自动开发流程                               │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📋 自动创建的任务清单                                              │   │
│  │                                                                      │   │
│  │  □ 研究Notion核心功能 (研究员负责)                                  │   │
│  │  □ 设计技术架构 (David负责)                                         │   │
│  │  □ 设计UI/UX (Elena负责)                                            │   │
│  │  □ 成本评估 (Frank负责)                                             │   │
│  │  □ 实现后端API                                                      │   │
│  │  □ 实现前端页面                                                     │   │
│  │  □ 自动测试验证                                                     │   │
│  │  □ 部署上线                                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ⚡ 并行执行中... 完成后会通知您                                           │
│                                                                              │
│  💡 您可以继续其他工作，或输入「进度」查看当前状态                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.2 [优化2] Todo Continuation Enforcer

#### 2.2.1 与Auto-Verify的整合

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  现有 Auto-Verify 流程                                                      │
│  ─────────────────────                                                      │
│                                                                              │
│  代码生成 → 验证 → 失败 → 修复 → 再验证 → 通过 → [结束]                   │
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  优化后: Auto-Verify + Todo Continuation                                    │
│  ─────────────────────────────────────────                                  │
│                                                                              │
│  代码生成 → 验证 → 失败 → 修复 → 再验证 → 通过                            │
│                                                     │                        │
│                                                     ▼                        │
│                                           ┌─────────────────┐               │
│                                           │ TODO检查        │               │
│                                           │                 │               │
│                                           │ 还有未完成的?   │               │
│                                           └────────┬────────┘               │
│                                                    │                        │
│                                        Yes         │         No             │
│                                        ┌───────────┴───────────┐            │
│                                        │                       │            │
│                                        ▼                       ▼            │
│                               ┌─────────────────┐    ┌─────────────────┐   │
│                               │ 强制继续        │    │ 真正结束        │   │
│                               │ "还有3个任务    │    │ 所有TODO完成    │   │
│                               │  未完成..."     │    │ 可以交付        │   │
│                               └─────────────────┘    └─────────────────┘   │
│                                        │                                    │
│                                        └──────────→ 返回继续开发            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 TODO追踪规则

```yaml
TODO来源:
  1. 用户需求分解出的任务列表
  2. AI在代码中添加的 // TODO 注释
  3. 验证失败需要修复的问题
  4. AI自己识别出需要后续处理的事项

TODO状态:
  - pending: 待处理
  - in_progress: 进行中
  - completed: 已完成
  - blocked: 被阻塞（需要用户输入）

强制继续条件:
  - 存在 pending 或 in_progress 状态的TODO
  - 且 blocked 数量为0（没有需要用户决策的）
  
允许结束条件:
  - 所有TODO都是 completed 状态
  - 或者用户主动输入「暂停」「停止」
  - 或者达到最大迭代次数（默认50轮）
```

#### 2.2.3 用户体验

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  🤖 David: 用户注册功能已完成基本实现...                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ⚠️ 检测到未完成的任务                                              │   │
│  │                                                                      │   │
│  │  已完成:                                                            │   │
│  │  ✅ 注册API实现                                                     │   │
│  │  ✅ 用户模型创建                                                    │   │
│  │  ✅ 密码加密处理                                                    │   │
│  │                                                                      │   │
│  │  未完成:                                                            │   │
│  │  □ 邮箱验证功能 (代码中有TODO注释)                                  │   │
│  │  □ 登录功能 (用户需求中包含)                                        │   │
│  │                                                                      │   │
│  │  🔄 继续完成剩余任务...                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  📝 正在实现邮箱验证功能...                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.3 [优化3] Comment Checker

#### 2.3.1 与Auto-Verify的整合

```yaml
新增验证项: comment-check

位置: 在 verify-build 之后，verify-ui 之前

触发条件: 有新生成或修改的代码文件

检查规则:
  有效注释 (保留):
    - // TODO: xxx
    - // FIXME: xxx
    - // @ts-ignore / @ts-expect-error
    - // eslint-disable-xxx
    - /** JSDoc 文档注释 */
    - // BDD风格测试描述
  
  可疑注释 (需要解释或删除):
    - // 获取用户信息 (代码自解释，无需注释)
    - // 这里处理错误 (废话注释)
    - // 下面的代码做xxx (冗余描述)
    - // Created by AI (暴露AI痕迹)
```

#### 2.3.2 用户体验

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  🔄 验证进度                                                        │   │
│  │                                                                      │   │
│  │  ✅ TypeScript 类型检查                          通过              │   │
│  │  ✅ ESLint 代码检查                              通过              │   │
│  │  ✅ 构建测试                                     通过              │   │
│  │  ⚠️ 注释质量检查                                 需要优化          │   │
│  │     └─ 发现 3 处可疑注释                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  📝 注释优化建议:                                                          │
│                                                                              │
│  1. user.ts:15 - "// 获取用户" → 删除 (代码已自解释)                      │
│  2. auth.ts:32 - "// 处理登录逻辑" → 删除 (函数名已说明)                  │
│  3. api.ts:8 - "// 这是API路由" → 删除 (文件位置已说明)                   │
│                                                                              │
│  🔧 正在自动清理不必要的注释...                                            │
│                                                                              │
│  ✅ 注释优化完成，代码更加简洁专业                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.4 [优化4] Context Window Monitor

#### 2.4.1 与Memory Controller的整合

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  现有 Memory Controller                                                     │
│  ─────────────────────────                                                  │
│                                                                              │
│  用户消息 → 判断是否需要记忆 → 决定检索模式 → 检索                        │
│  (被动响应)                                                                 │
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  优化后: Memory Controller + Context Window Monitor                         │
│  ─────────────────────────────────────────────────────                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Context Window Monitor (持续监控)                                  │   │
│  │                                                                      │   │
│  │  当前使用率: ████████████████░░░░ 78%                               │   │
│  │                                                                      │   │
│  │  阈值:                                                              │   │
│  │  • 70% - 提醒AI还有空间，不要匆忙                                   │   │
│  │  • 85% - 触发主动压缩                                               │   │
│  │  • 95% - 紧急压缩 + 通知用户                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  触发动作:                                                                  │
│  • 70%: 注入提示 "上下文还有30%空间，请保持高质量输出"                    │
│  • 85%: 自动调用Compressor压缩历史消息                                    │
│  • 95%: 紧急模式 - 只保留最近3轮对话 + 关键记忆                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.4.2 与Session Summary的协同

```yaml
主动压缩流程:

1. 触发条件: 上下文使用率 >= 85%

2. 压缩步骤:
   a. 调用Session Summary生成当前会话摘要
   b. 保留最近3轮对话原文
   c. 将之前的对话替换为摘要
   d. 保留所有TODO状态
   e. 保留当前文件上下文

3. 压缩后注入:
   "[系统] 上下文已优化，之前的讨论摘要如下:
   - 用户需求: xxx
   - 已完成: xxx
   - 当前进度: xxx
   - 待处理: xxx"

4. 效果: 
   - 上下文使用率从85%降到40%左右
   - 关键信息不丢失
   - AI可以继续高质量工作
```

---

### 2.5 [优化5] Session Recovery

#### 2.5.1 错误类型与恢复策略

```yaml
错误类型及恢复:

1. API调用错误:
   错误: "Rate limit exceeded" / "Service unavailable"
   恢复: 等待重试(指数退避) → 切换备用模型 → 通知用户
   
2. 工具执行错误:
   错误: "Tool execution timeout" / "Tool not found"
   恢复: 记录错误 → 跳过该工具 → 尝试替代方案 → 继续流程

3. 上下文错误:
   错误: "Context length exceeded" / "Invalid message format"
   恢复: 触发紧急压缩 → 清理无效消息 → 重新发送

4. 思考块错误 (Claude特有):
   错误: "Thinking block malformed"
   恢复: 清理thinking内容 → 重新格式化 → 重试

5. 空消息错误:
   错误: "Empty message content"
   恢复: 自动填充默认内容 → 继续流程

6. 沙盒执行错误:
   错误: "Sandbox crashed" / "Process killed"
   恢复: 重启沙盒 → 恢复文件状态 → 继续执行
```

#### 2.5.2 用户体验

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  [正常情况 - 用户无感知]                                                    │
│                                                                              │
│  内部: API超时 → 自动重试 → 成功                                           │
│  用户看到: 正常的响应 (可能稍慢几秒)                                       │
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  [需要通知用户的情况]                                                       │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  ⚠️ 系统自动恢复                                                    │   │
│  │                                                                      │   │
│  │  检测到临时问题，已自动处理:                                        │   │
│  │  • 问题: 代码执行超时                                               │   │
│  │  • 处理: 已重启执行环境                                             │   │
│  │  • 状态: 您的工作进度已恢复，无数据丢失                             │   │
│  │                                                                      │   │
│  │  正在继续之前的任务...                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.6 [优化6] 新增研究员角色 (Librarian)

#### 2.6.1 与现有高管体系的关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  现有AI高管体系 (18人)                                                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  CEO层: Mike, Olivia                                                │   │
│  │  技术层: David, Henry, Ivan, Jack, Kevin, Leo                       │   │
│  │  设计层: Elena                                                      │   │
│  │  业务层: Frank, Grace, Nancy, Paul, Quinn, Rachel, Sarah, Tom, Uma  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ════════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  新增: Librarian (研究员) - 编号19                                         │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  📚 Librarian (研究员)                                              │   │
│  │                                                                      │   │
│  │  定位: 不写代码，专门做研究和信息收集                               │   │
│  │                                                                      │   │
│  │  职责:                                                              │   │
│  │  • 查找官方文档和API参考                                            │   │
│  │  • 研究开源项目的实现方式                                           │   │
│  │  • 收集行业最佳实践                                                 │   │
│  │  • 为其他高管提供参考资料                                           │   │
│  │                                                                      │   │
│  │  模型: Claude Sonnet (便宜但聪明)                                   │   │
│  │                                                                      │   │
│  │  工具:                                                              │   │
│  │  • MCP: context7 (官方文档)                                         │   │
│  │  • MCP: grep_app (GitHub代码搜索)                                   │   │
│  │  • Web Search (网络搜索)                                            │   │
│  │  • 项目代码库搜索                                                   │   │
│  │                                                                      │   │
│  │  输出格式:                                                          │   │
│  │  结构化的研究报告，包含:                                            │   │
│  │  - 关键发现                                                         │   │
│  │  - 代码示例                                                         │   │
│  │  - 推荐做法                                                         │   │
│  │  - 参考链接                                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 2.6.2 使用场景

```yaml
场景1 - 技术选型时自动调用:
  用户: "做一个实时聊天功能"
  
  流程:
  1. David收到需求
  2. 自动调用Librarian: "研究实时聊天的最佳技术方案"
  3. Librarian返回:
     - Socket.io vs WebSocket原生 对比
     - 主流开源实现分析
     - 推荐方案及理由
  4. David基于研究结果做技术决策

场景2 - 遇到问题时调用:
  David: "这个错误不太常见，需要查一下"
  
  流程:
  1. David调用Librarian: "研究 Next.js hydration error 解决方案"
  2. Librarian搜索GitHub Issues + Stack Overflow + 官方文档
  3. 返回已验证的解决方案

场景3 - 用户主动调用:
  用户: "研究一下 Notion 的编辑器是怎么实现的"
  
  流程:
  1. 识别为研究类需求
  2. 直接派给Librarian
  3. Librarian深度研究并返回报告
```

---

## 三、优化项之间的协同

### 3.1 完整优化后的工作流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  用户: "做一个电商网站 全力"                                               │
│                                                                              │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  Step 1: Magic Keyword 检测                                                 │
│  ─────────────────────────────                                              │
│  检测到「全力」→ 启动全自动模式                                            │
│  • 启用Subagents并行                                                        │
│  • 启用Todo Continuation                                                    │
│  • 启用所有验证                                                             │
│                                                                              │
│  Step 2: 任务分解 + TODO列表创建                                           │
│  ─────────────────────────────────                                          │
│  Mike创建TODO列表:                                                          │
│  □ 研究电商最佳实践 (Librarian)                                            │
│  □ 设计技术架构 (David)                                                    │
│  □ 设计UI/UX (Elena)                                                       │
│  □ 成本评估 (Frank)                                                        │
│  □ 实现商品模块                                                            │
│  □ 实现购物车模块                                                          │
│  □ 实现订单模块                                                            │
│  □ 实现支付模块                                                            │
│  □ 自动测试验证                                                            │
│  □ 部署上线                                                                │
│                                                                              │
│  Step 3: 并行研究阶段                                                      │
│  ────────────────────────                                                   │
│  ├── Librarian: 研究电商最佳实践                                           │
│  ├── David: 设计技术架构                                                   │
│  ├── Elena: 设计UI/UX                                                      │
│  └── Frank: 成本评估                                                       │
│                                                                              │
│  (Context Monitor: 当前使用率45%)                                          │
│                                                                              │
│  Step 4: 并行开发阶段                                                      │
│  ────────────────────────                                                   │
│  ├── Subagent-1: 商品模块                                                  │
│  ├── Subagent-2: 购物车模块                                                │
│  ├── Subagent-3: 订单模块                                                  │
│  └── Subagent-4: 支付模块                                                  │
│                                                                              │
│  (Context Monitor: 当前使用率72% - 提醒继续高质量)                         │
│                                                                              │
│  Step 5: Auto-Verify验证                                                   │
│  ─────────────────────────                                                  │
│  ✅ TypeScript检查                                                         │
│  ✅ ESLint检查                                                             │
│  ✅ 构建测试                                                               │
│  ⚠️ Comment检查 → 自动清理3处冗余注释                                      │
│  ✅ 单元测试                                                               │
│  ✅ UI验证                                                                 │
│                                                                              │
│  Step 6: Todo Continuation检查                                             │
│  ─────────────────────────────                                              │
│  检查TODO列表:                                                              │
│  ✅ 研究电商最佳实践                                                       │
│  ✅ 设计技术架构                                                           │
│  ✅ 设计UI/UX                                                              │
│  ✅ 成本评估                                                               │
│  ✅ 实现商品模块                                                           │
│  ✅ 实现购物车模块                                                         │
│  ✅ 实现订单模块                                                           │
│  ✅ 实现支付模块                                                           │
│  ✅ 自动测试验证                                                           │
│  □ 部署上线 ← 还有1个未完成！                                             │
│                                                                              │
│  🔄 继续完成「部署上线」...                                                │
│                                                                              │
│  (Context Monitor: 使用率86% → 触发主动压缩)                               │
│  (Session Recovery: 压缩完成，继续执行)                                    │
│                                                                              │
│  Step 7: 完成部署                                                          │
│  ─────────────────                                                          │
│  ✅ 推送到GitHub                                                           │
│  ✅ 部署到Vercel                                                           │
│  ✅ 配置域名                                                               │
│                                                                              │
│  Step 8: 最终检查                                                          │
│  ─────────────────                                                          │
│  Todo Continuation: 所有TODO完成 ✓                                        │
│  Auto-Verify: 所有验证通过 ✓                                               │
│                                                                              │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                              │
│  ✅ 完成！您的电商网站已上线: https://xxx.vercel.app                      │
│                                                                              │
│  📊 开发统计:                                                               │
│  • 总耗时: 45分钟                                                          │
│  • 并行任务: 12个                                                          │
│  • 自动修复: 5次                                                           │
│  • 清理注释: 8处                                                           │
│  • 上下文压缩: 2次                                                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、成功指标

### 4.1 效率指标

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 任务完成率 | ~70% (经常半途而废) | 99%+ (强制完成) | 40%↑ |
| 首次交付成功率 | ~40% | ~95% | 137%↑ |
| 平均返工次数 | 3-5次 | <1次 | 80%↓ |
| 用户干预次数 | 5-10次/任务 | 0-1次/任务 | 90%↓ |

### 4.2 质量指标

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 代码注释质量 | 参差不齐 | 专业简洁 | 显著↑ |
| 会话稳定性 | 偶尔崩溃需重来 | 自动恢复 | 稳定性↑ |
| 上下文利用率 | 经常撞墙 | 主动管理 | 效率↑ |

### 4.3 用户体验指标

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 启动模式 | 需要详细描述 | 一个关键词触发 |
| 进度感知 | 不知道AI在干嘛 | 清晰的TODO进度 |
| 错误处理 | 需要用户干预 | 自动恢复无感知 |

---

## 五、开发优先级

### P0: 核心优化 (1.5周)

| 优化项 | 工作量 | 依赖 |
|--------|--------|------|
| Magic Keyword检测 | 2天 | 无 |
| Todo Continuation | 3天 | Auto-Verify |
| Comment Checker | 2天 | Auto-Verify |

### P1: 稳定性优化 (1周)

| 优化项 | 工作量 | 依赖 |
|--------|--------|------|
| Context Window Monitor | 2天 | Memory Controller |
| Session Recovery | 3天 | 无 |

### P2: 能力扩展 (1周)

| 优化项 | 工作量 | 依赖 |
|--------|--------|------|
| Librarian角色 | 3天 | MCP |
| 与MCP集成 (context7, grep_app) | 2天 | MCP框架 |

---

**配套文档**: [系统优化升级技术架构](./12-OPTIMIZATION-TECH.md)
