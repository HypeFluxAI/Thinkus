# Thinkus AI自动验证闭环系统 - 产品需求文档

> **版本**: v1.0 | **日期**: 2026-01-15
>
> **核心理念**: AI不只负责"生成"，还要负责"验证"
>
> **目标**: 用户拿到的是"已验证通过的结果"，而不是"可能能用的代码"

---

## 一、问题分析

### 1.1 当前AI编程的痛点

```
传统流程:
AI写代码 → 用户运行 → 发现问题 → 告诉AI → AI修复 → 用户再运行 → 又有问题...

问题:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  ❌ AI对自己写的代码过于自信                                        │
│  ❌ 不跑、不测、不看效果，永远觉得"已经OK了"                        │
│  ❌ 用户浪费大量时间在来回测试和纠错                                │
│  ❌ 每次都是"可能能用的代码"，交付质量不稳定                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 理想流程

```
自动验证闭环:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│   AI写代码 → 自动验证 → 失败 → AI分析 → AI修复 → 再验证 → 成功     │
│                  │                                    │              │
│                  └────────── 自动循环 ────────────────┘              │
│                                                                      │
│   用户拿到的是: 已经被验证过的、可以直接用的结果                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 核心价值

| 指标 | 无验证 | 有验证 | 提升 |
|------|--------|--------|------|
| 首次交付成功率 | ~40% | ~90% | 125%↑ |
| 平均返工次数 | 3-5次 | 0-1次 | 80%↓ |
| 用户调试时间 | 30分钟+ | <5分钟 | 85%↓ |
| Bug到达用户 | 高 | 极低 | 95%↓ |

---

## 二、产品设计

### 2.1 验证类型矩阵

```
┌─────────────────────────────────────────────────────────────────────┐
│                       验证类型矩阵                                   │
│                                                                      │
│  改动类型              触发的验证                 验证工具           │
│  ────────────────────────────────────────────────────────────────   │
│                                                                      │
│  后端逻辑              单元测试 + 集成测试        Jest/Vitest        │
│  API接口               API测试 + 类型检查        Supertest + tsc    │
│  数据库Schema          Migration测试             Prisma migrate     │
│  依赖变更              构建验证 + 类型检查       npm build + tsc    │
│  前端组件              组件测试 + 构建           Vitest + build     │
│  UI样式                视觉验证 + 响应式         Browser + 截图     │
│  页面交互              E2E测试                   Playwright         │
│  表单功能              功能测试                  Browser action     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Verify Subagent 体系

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Verify Subagent 体系                           │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    Verify Orchestrator                        │  │
│  │                    (验证编排器)                                │  │
│  │                                                                │  │
│  │  职责:                                                        │  │
│  │  • 分析代码改动，决定需要哪些验证                             │  │
│  │  • 调度对应的Verify Subagent                                  │  │
│  │  • 收集验证结果，决定是否需要修复                             │  │
│  │  • 控制验证-修复循环次数                                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                              │                                       │
│         ┌────────────────────┼────────────────────┐                 │
│         │                    │                    │                 │
│         ▼                    ▼                    ▼                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐           │
│  │ verify-code │     │ verify-build│     │  verify-ui  │           │
│  │             │     │             │     │             │           │
│  │ • 单元测试  │     │ • 类型检查  │     │ • 打开页面  │           │
│  │ • 集成测试  │     │ • 构建验证  │     │ • 视觉对比  │           │
│  │ • API测试   │     │ • Lint检查  │     │ • 交互测试  │           │
│  └─────────────┘     └─────────────┘     └─────────────┘           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 用户体验设计

#### 默认行为（推荐）

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  用户: "添加一个用户注册功能"                                       │
│                                                                      │
│  ════════════════════════════════════════════════════════════════   │
│                                                                      │
│  🤖 David: 好的，我来实现用户注册功能...                            │
│                                                                      │
│  [代码生成中...]                                                     │
│                                                                      │
│  ✅ 代码已生成，正在自动验证...                                     │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  🔄 验证进度                                                 │   │
│  │                                                              │   │
│  │  ✅ TypeScript 类型检查                          通过       │   │
│  │  ✅ ESLint 代码检查                              通过       │   │
│  │  ✅ 构建测试                                     通过       │   │
│  │  🔄 单元测试                                     运行中...  │   │
│  │  ⏳ API测试                                      等待中     │   │
│  │  ⏳ UI验证                                       等待中     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

#### 验证失败自动修复

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  🔄 验证进度                                                 │   │
│  │                                                              │   │
│  │  ✅ TypeScript 类型检查                          通过       │   │
│  │  ❌ 单元测试                                     失败       │   │
│  │     └─ registerUser.test.ts: 期望邮箱格式验证               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  🔧 发现问题，正在自动修复...                                       │
│                                                                      │
│  分析: 测试期望对邮箱格式进行验证，但当前实现缺少此逻辑            │
│  修复: 在registerUser函数中添加邮箱格式验证                         │
│                                                                      │
│  [修复代码中...]                                                     │
│                                                                      │
│  ✅ 修复完成，重新验证...                                           │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  🔄 验证进度 (第2轮)                                        │   │
│  │                                                              │   │
│  │  ✅ TypeScript 类型检查                          通过       │   │
│  │  ✅ 单元测试                                     通过       │   │
│  │  ✅ API测试                                      通过       │   │
│  │  ✅ UI验证                                       通过       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  ✅ 所有验证通过！用户注册功能已完成。                              │
│                                                                      │
│  修复记录:                                                          │
│  • 添加了邮箱格式验证 (registerUser.ts:15)                         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

#### UI验证展示

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  🖥️ UI验证                                                          │
│                                                                      │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐  │
│  │   期望效果                  │  │   实际效果                  │  │
│  │   (设计稿/需求描述)         │  │   (浏览器截图)              │  │
│  │                             │  │                             │  │
│  │   ┌─────────────────────┐  │  │   ┌─────────────────────┐   │  │
│  │   │     注册表单        │  │  │   │     注册表单        │   │  │
│  │   │                     │  │  │   │                     │   │  │
│  │   │  邮箱: [________]   │  │  │   │  邮箱: [________]   │   │  │
│  │   │  密码: [________]   │  │  │   │  密码: [________]   │   │  │
│  │   │                     │  │  │   │                     │   │  │
│  │   │     [注册]          │  │  │   │     [注册]          │   │  │
│  │   └─────────────────────┘  │  │   └─────────────────────┘   │  │
│  └─────────────────────────────┘  └─────────────────────────────┘  │
│                                                                      │
│  ✅ 视觉一致性检查: 通过                                            │
│  ✅ 响应式检查: 桌面✓ 平板✓ 手机✓                                   │
│  ✅ 交互测试: 表单提交正常                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.4 验证配置（可选）

```
┌─────────────────────────────────────────────────────────────────────┐
│  ⚙️ 项目设置 > 自动验证                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  验证模式                                                            │
│  ─────────                                                          │
│  ○ 完全自动 - 每次代码变更都自动验证                                │
│  ● 智能验证 - 根据改动类型自动选择验证项 (推荐)                     │
│  ○ 手动触发 - 仅在明确要求时验证                                    │
│                                                                      │
│  验证项目                                                            │
│  ─────────                                                          │
│  ☑️ TypeScript类型检查                                               │
│  ☑️ ESLint代码检查                                                   │
│  ☑️ 构建验证                                                         │
│  ☑️ 单元测试                                                         │
│  ☑️ API测试                                                          │
│  ☑️ UI视觉验证                                                       │
│  ☐ E2E完整测试 (耗时较长)                                           │
│                                                                      │
│  自动修复                                                            │
│  ─────────                                                          │
│  ☑️ 验证失败时自动尝试修复                                           │
│  最大修复轮次: [3] 轮                                                │
│  ☑️ 修复失败时暂停并通知用户                                         │
│                                                                      │
│  [保存设置]                                                          │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、验证流程详解

### 3.1 智能验证触发规则

```yaml
触发规则 (根据文件变更自动判断):

后端文件 (*.ts in /api, /server, /lib):
  必选:
    - TypeScript类型检查
    - ESLint
    - 构建测试
  可选:
    - 单元测试 (如果存在对应测试文件)
    - API测试 (如果是API路由文件)

前端组件 (*.tsx in /components):
  必选:
    - TypeScript类型检查
    - ESLint
    - 构建测试
  可选:
    - 组件测试 (如果存在对应测试文件)

页面文件 (*.tsx in /app, /pages):
  必选:
    - TypeScript类型检查
    - 构建测试
  可选:
    - UI视觉验证 (打开页面截图)
    - 响应式验证

样式文件 (*.css, *.scss, tailwind):
  必选:
    - 构建测试
  可选:
    - UI视觉验证

配置文件 (package.json, tsconfig.json, etc):
  必选:
    - 构建测试
    - TypeScript类型检查

数据库相关 (prisma/schema.prisma, migrations):
  必选:
    - Prisma生成
    - Migration验证
```

### 3.2 验证-修复闭环

```
┌─────────────────────────────────────────────────────────────────────┐
│                        验证-修复闭环流程                            │
│                                                                      │
│  ┌──────────┐                                                       │
│  │ 代码变更 │                                                       │
│  └────┬─────┘                                                       │
│       │                                                             │
│       ▼                                                             │
│  ┌──────────────────┐                                               │
│  │ Verify           │                                               │
│  │ Orchestrator     │◄────────────────────────────┐                │
│  │                  │                             │                │
│  │ 1. 分析变更类型  │                             │                │
│  │ 2. 选择验证项    │                             │                │
│  └────────┬─────────┘                             │                │
│           │                                        │                │
│           ▼                                        │                │
│  ┌──────────────────┐                             │                │
│  │ 执行验证         │                             │                │
│  │                  │                             │                │
│  │ • verify-code    │                             │                │
│  │ • verify-build   │                             │                │
│  │ • verify-ui      │                             │                │
│  └────────┬─────────┘                             │                │
│           │                                        │                │
│           ▼                                        │                │
│      ┌─────────┐                                  │                │
│      │ 全部通过?│                                  │                │
│      └────┬────┘                                  │                │
│           │                                        │                │
│     Yes   │   No                                  │                │
│     ┌─────┴─────┐                                 │                │
│     │           │                                 │                │
│     ▼           ▼                                 │                │
│  ┌──────┐  ┌──────────────┐                      │                │
│  │ 完成 │  │ 分析失败原因 │                      │                │
│  └──────┘  └──────┬───────┘                      │                │
│                   │                               │                │
│                   ▼                               │                │
│            ┌────────────┐                        │                │
│            │ 轮次 < 3?  │                        │                │
│            └──────┬─────┘                        │                │
│                   │                               │                │
│             Yes   │   No                         │                │
│             ┌─────┴─────┐                        │                │
│             │           │                        │                │
│             ▼           ▼                        │                │
│       ┌──────────┐  ┌────────────┐              │                │
│       │ AI修复   │  │ 通知用户   │              │                │
│       │ 代码     │  │ 人工介入   │              │                │
│       └────┬─────┘  └────────────┘              │                │
│            │                                     │                │
│            └─────────────────────────────────────┘                │
│                    (返回重新验证)                                  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

### 3.3 失败分析与修复策略

```yaml
常见失败类型及修复策略:

TypeScript错误:
  类型不匹配:
    策略: 分析期望类型和实际类型，修正类型定义或值
    示例: "Type 'string' is not assignable to type 'number'"
    修复: 检查数据来源，添加类型转换或修正类型定义
  
  缺少属性:
    策略: 添加缺失的属性或标记为可选
    示例: "Property 'email' is missing"
    修复: 在对象中添加email属性

构建错误:
  模块未找到:
    策略: 检查导入路径，安装缺失依赖
    示例: "Cannot find module 'lodash'"
    修复: npm install lodash

  语法错误:
    策略: 定位语法问题，修正代码
    示例: "Unexpected token"
    修复: 检查括号、引号匹配

测试失败:
  断言失败:
    策略: 分析期望值和实际值，决定修改代码还是测试
    示例: "Expected: 200, Received: 400"
    修复: 检查API逻辑，确保返回正确状态码
  
  超时:
    策略: 检查异步操作，添加必要的await
    示例: "Timeout - Async callback was not invoked"
    修复: 确保Promise正确resolve

UI验证失败:
  元素未找到:
    策略: 检查选择器，确保元素正确渲染
    示例: "Element not found: .submit-button"
    修复: 检查组件是否正确渲染，选择器是否正确
  
  视觉差异:
    策略: 对比截图，分析样式差异
    修复: 调整CSS样式
```

---

## 四、与现有系统集成

### 4.1 与Subagents集成

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  开发Subagent完成代码后，自动触发验证Subagent                       │
│                                                                      │
│  用户需求                                                            │
│      │                                                               │
│      ▼                                                               │
│  ┌────────────┐                                                     │
│  │   David    │ 分解任务                                            │
│  │  (主Agent) │                                                     │
│  └─────┬──────┘                                                     │
│        │                                                             │
│        ├────────────────┬────────────────┐                          │
│        ▼                ▼                ▼                          │
│  ┌───────────┐   ┌───────────┐   ┌───────────┐                     │
│  │ Subagent  │   │ Subagent  │   │ Subagent  │                     │
│  │ 用户模块  │   │ 订单模块  │   │ 支付模块  │                     │
│  └─────┬─────┘   └─────┬─────┘   └─────┬─────┘                     │
│        │               │               │                            │
│        ▼               ▼               ▼                            │
│  ┌───────────┐   ┌───────────┐   ┌───────────┐                     │
│  │ verify-   │   │ verify-   │   │ verify-   │                     │
│  │ code      │   │ code      │   │ code      │                     │
│  └─────┬─────┘   └─────┬─────┘   └─────┬─────┘                     │
│        │               │               │                            │
│        └───────────────┴───────────────┘                            │
│                        │                                             │
│                        ▼                                             │
│                 ┌─────────────┐                                     │
│                 │ 全部通过后  │                                     │
│                 │ 集成测试    │                                     │
│                 └─────────────┘                                     │
│                        │                                             │
│                        ▼                                             │
│                 ┌─────────────┐                                     │
│                 │ verify-ui   │                                     │
│                 │ 完整验证    │                                     │
│                 └─────────────┘                                     │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 与Browser Service集成

```yaml
verify-ui 使用 Browser Service:

1. 启动开发服务器
2. 等待编译完成
3. 打开目标页面
4. 执行验证:
   - 截图对比
   - 响应式检查 (桌面/平板/手机)
   - 交互测试 (点击、输入、提交)
5. 收集结果
6. 如有问题，生成详细报告
```

### 4.3 与实时预览集成

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│  实时预览 + 自动验证 = 所见即所得 + 质量保证                        │
│                                                                      │
│  ┌─────────────────────────┐  ┌─────────────────────────────────┐  │
│  │       代码编辑区        │  │         实时预览区              │  │
│  │                         │  │                                  │  │
│  │  // 修改代码...         │  │   ┌──────────────────────────┐  │  │
│  │                         │  │   │                          │  │  │
│  │                         │  │   │      [实时界面]          │  │  │
│  │                         │  │   │                          │  │  │
│  │                         │  │   └──────────────────────────┘  │  │
│  │                         │  │                                  │  │
│  │                         │  │   验证状态:                      │  │
│  │                         │  │   ✅ 类型检查 ✅ 构建 ✅ 测试   │  │
│  └─────────────────────────┘  └─────────────────────────────────┘  │
│                                                                      │
│  代码变更 → 自动验证 → 验证通过 → 更新预览                         │
│              │                                                       │
│              └→ 验证失败 → 自动修复 → 重新验证                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 五、成功指标

### 5.1 核心指标

| 指标 | 当前 | 目标 | 说明 |
|------|------|------|------|
| 首次交付成功率 | ~40% | >90% | 验证通过才交付 |
| 平均返工次数 | 3-5次 | <1次 | AI自动修复 |
| Bug逃逸率 | 高 | <5% | 验证闭环保障 |
| 用户调试时间 | 30分钟+ | <5分钟 | 大部分问题AI已解决 |

### 5.2 用户体验指标

| 指标 | 目标 | 说明 |
|------|------|------|
| 验证完成时间 | <2分钟 | 快速验证 |
| 自动修复成功率 | >80% | 减少人工介入 |
| 验证结果清晰度 | >90%满意 | 用户能理解发生了什么 |

---

## 六、开发优先级

### P0: 核心验证能力 (2周)

| 功能 | 工作量 | 说明 |
|------|--------|------|
| Verify Orchestrator | 3天 | 验证编排器 |
| verify-build | 2天 | 类型检查+构建验证 |
| verify-code | 3天 | 单元测试+API测试 |
| 自动修复基础 | 2天 | 失败分析+修复建议 |

### P1: UI验证 (1周)

| 功能 | 工作量 | 说明 |
|------|--------|------|
| verify-ui | 3天 | 浏览器验证 |
| 响应式检查 | 1天 | 多设备截图 |
| 交互测试 | 1天 | 基础交互验证 |

### P2: 高级功能 (1周)

| 功能 | 工作量 | 说明 |
|------|--------|------|
| 验证配置UI | 2天 | 用户可配置 |
| 验证报告 | 2天 | 详细报告展示 |
| E2E测试 | 1天 | 完整流程测试 |

---

**配套文档**: [自动验证闭环技术架构](./08-AUTO-VERIFY-TECH.md)
