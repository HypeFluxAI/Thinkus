version: '3.8'

services:
  # Next.js 主服务 (开发模式)
  app:
    build:
      context: ./thinkus-app
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    volumes:
      - ./thinkus-app:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - GRPC_PY_SERVICE_URL=py-service:50051
      - GRPC_ANALYTICS_URL=go-analytics:50052
      - GRPC_SANDBOX_URL=go-sandbox:50053
      - AI_GUIDE_URL=http://py-ai-guide:8001
      - AI_SUPPORT_URL=http://py-ai-support:8002
      - AI_CARE_URL=http://go-ai-care:8003
    depends_on:
      - py-service
      - go-analytics
      - go-sandbox
      - py-ai-guide
      - py-ai-support
      - go-ai-care
      - redis
    command: pnpm dev

  # Python 微服务 (开发模式)
  py-service:
    build:
      context: ./services/py-service
      dockerfile: Dockerfile.dev
    ports:
      - "50051:50051"
      - "8000:8000"
    volumes:
      - ./services/py-service/src:/app/src
      - ./services/proto:/app/proto
    environment:
      - GRPC_PORT=50051
    command: >
      sh -c "python -m grpc_tools.protoc -I./proto --python_out=./src/proto --grpc_python_out=./src/proto ./proto/*.proto &&
             uvicorn src.main:app --reload --host 0.0.0.0 --port 8000"

  # Go Analytics 微服务 (开发模式)
  go-analytics:
    build:
      context: ./services/go-analytics
      dockerfile: Dockerfile.dev
    ports:
      - "50052:50052"
    volumes:
      - ./services/go-analytics:/app
      - ./services/proto:/app/proto
    environment:
      - REDIS_URL=redis://redis:6379
      - GRPC_PORT=50052
    depends_on:
      - redis
    command: air -c .air.toml

  # Go Sandbox 微服务 (开发模式)
  go-sandbox:
    build:
      context: ./services/go-sandbox
      dockerfile: Dockerfile.dev
    ports:
      - "50053:50053"
    volumes:
      - ./services/go-sandbox:/app
      - ./services/proto:/app/proto
      - /var/run/docker.sock:/var/run/docker.sock
      - sandbox-data:/data/sandboxes
    environment:
      - GRPC_PORT=50053
      - DATA_DIR=/data/sandboxes
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      - claude-code-image
    privileged: true
    command: air -c .air.toml

  # Claude Code 沙盒镜像 (预构建)
  claude-code-image:
    build:
      context: ./services/go-sandbox/images/claude-code
      dockerfile: Dockerfile
    image: thinkus/claude-code:latest
    command: ["echo", "Claude Code image built successfully"]

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  # ============================================
  # AI 服务 (小白用户支持) - 开发模式
  # ============================================

  # AI 产品导游服务 (Python)
  py-ai-guide:
    build:
      context: ./services/py-ai-guide
      dockerfile: Dockerfile.dev
    ports:
      - "8001:8001"
    volumes:
      - ./services/py-ai-guide/src:/app/src
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://host.docker.internal:27017}
      - MONGODB_DATABASE=thinkus
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PORT=8001
      - DEBUG=true
    depends_on:
      - redis

  # AI 智能客服服务 (Python)
  py-ai-support:
    build:
      context: ./services/py-ai-support
      dockerfile: Dockerfile.dev
    ports:
      - "8002:8002"
    volumes:
      - ./services/py-ai-support/src:/app/src
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://host.docker.internal:27017}
      - MONGODB_DATABASE=thinkus
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PORT=8002
      - DEBUG=true
      - AI_GUIDE_URL=http://py-ai-guide:8001
    depends_on:
      - redis
      - py-ai-guide

  # AI 主动关怀服务 (Go)
  go-ai-care:
    build:
      context: ./services/go-ai-care
      dockerfile: Dockerfile.dev
    ports:
      - "8003:8003"
    volumes:
      - ./services/go-ai-care:/app
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://host.docker.internal:27017}
      - MONGODB_DATABASE=thinkus
      - REDIS_URL=redis://redis:6379
      - PORT=8003
      - GIN_MODE=debug
    depends_on:
      - redis

volumes:
  redis-data:
  sandbox-data:

networks:
  default:
    name: thinkus-dev-network
