# ============================================================
# Thinkus API 规格
# 格式: 简化版，便于AI理解
# ============================================================

base: /api/trpc

# ============================================================
# 认证
# ============================================================
auth:

  register:
    method: mutation
    input:
      name: string, required, min:2
      email: string, required, email
      password: string, required, min:8
    output:
      user: User
      token: string
    errors:
      - code: EMAIL_EXISTS
        message: 邮箱已存在

  login:
    method: mutation
    input:
      email: string, required
      password: string, required
    output:
      user: User
      token: string
    errors:
      - code: INVALID_CREDENTIALS
        message: 邮箱或密码错误

  oauth:
    method: mutation
    input:
      provider: google | github
      code: string, required
    output:
      user: User
      token: string
      isNewUser: boolean

  logout:
    method: mutation
    auth: required
    output:
      success: boolean

  me:
    method: query
    auth: required
    output:
      user: User

# ============================================================
# 项目
# ============================================================
projects:

  list:
    method: query
    auth: required
    input:
      status?: ProjectStatus
      page?: number = 1
      limit?: number = 20, max:50
    output:
      projects: Project[]
      total: number
      page: number
      totalPages: number

  get:
    method: query
    auth: required
    input:
      id: string
    output:
      project: Project
    errors:
      - code: NOT_FOUND

  create:
    method: mutation
    auth: required
    input:
      requirement: string, required, min:20
      attachments?: string[]
    output:
      project: Project
      conversationId: string

  update:
    method: mutation
    auth: required
    input:
      id: string
      name?: string
      icon?: string
    output:
      project: Project

  delete:
    method: mutation
    auth: required
    input:
      id: string
    output:
      success: boolean

  confirm:
    method: mutation
    auth: required
    input:
      id: string
      selectedAdditions?: string[]
    output:
      project: Project
    desc: 确认方案，进入待支付状态

# ============================================================
# 讨论
# ============================================================
discussions:

  create:
    method: mutation
    auth: required
    input:
      projectId: string
      mode: DiscussionMode = standard
    output:
      discussion: Discussion
    desc: 开始专家讨论

  get:
    method: query
    auth: required
    input:
      id: string
    output:
      discussion: Discussion

  stream:
    method: subscription
    auth: required
    input:
      id: string
    output:
      event: DiscussionEvent
    events:
      - type: round_start
        data: { round: number, phase: string }
      - type: expert_speaking
        data: { expertId: string }
      - type: expert_message
        data: { expertId: string, content: string, timestamp: Date }
      - type: round_summary
        data: { summary: string, consensus: string[] }
      - type: waiting_for_user
        data: { prompt: string }
      - type: conclusion
        data: { conclusion: Conclusion }
    desc: SSE事件流

  input:
    method: mutation
    auth: required
    input:
      discussionId: string
      content: string
      type: question | comment | decision
    output:
      responses: ExpertMessage[]
    desc: 用户插入发言

  skip:
    method: mutation
    auth: required
    input:
      id: string
    output:
      discussion: Discussion

  pause:
    method: mutation
    auth: required
    input:
      id: string
    output:
      discussion: Discussion

  resume:
    method: mutation
    auth: required
    input:
      id: string
    output:
      discussion: Discussion

# ============================================================
# 对话
# ============================================================
chat:

  get:
    method: query
    auth: required
    input:
      projectId: string
    output:
      conversation: Conversation

  send:
    method: mutation
    auth: required
    input:
      projectId: string
      content: string
      attachments?: string[]
    output:
      userMessage: Message
      assistantMessage: Message
    desc: 发送消息，返回AI回复

  stream:
    method: subscription
    auth: required
    input:
      projectId: string
      content: string
    output:
      chunk: string
    desc: 流式返回AI回复

# ============================================================
# 支付
# ============================================================
payments:

  createIntent:
    method: mutation
    auth: required
    input:
      projectId: string
    output:
      clientSecret: string
      amount: number
    desc: 创建Stripe支付意向

  confirm:
    method: mutation
    auth: required
    input:
      projectId: string
      paymentIntentId: string
    output:
      payment: Payment
      project: Project
    desc: 确认支付完成

# ============================================================
# 用户设置
# ============================================================
user:

  getSettings:
    method: query
    auth: required
    output:
      settings: UserSettings

  updateSettings:
    method: mutation
    auth: required
    input:
      language?: string
      theme?: string
      timezone?: string
      notifications?: object
    output:
      settings: UserSettings

  updateProfile:
    method: mutation
    auth: required
    input:
      name?: string
      avatar?: string
    output:
      user: User

# ============================================================
# 进度
# ============================================================
progress:

  get:
    method: query
    auth: required
    input:
      projectId: string
    output:
      progress: ProjectProgress

  stream:
    method: subscription
    auth: required
    input:
      projectId: string
    output:
      event: ProgressEvent
    events:
      - type: percentage_update
        data: { percentage: number }
      - type: stage_change
        data: { stage: string, status: string }
      - type: log
        data: { log: DevLog }
      - type: completed
        data: { project: Project }

# ============================================================
# 结构化规格 ⭐
# ============================================================
specs:

  generate:
    method: mutation
    auth: required
    input:
      projectId: string
    output:
      specs: ProjectSpec
    desc: 生成项目结构化规格

  get:
    method: query
    auth: required
    input:
      projectId: string
      version?: number
    output:
      specs: ProjectSpec

  getFiles:
    method: query
    auth: required
    input:
      projectId: string
    output:
      files:
        projectYaml: string
        dataModels: string
        apiSpecs: string
        pageSpecs: { route: string, content: string }[]
    desc: 获取规格文件内容

  preview:
    method: query
    auth: required
    input:
      projectId: string
    output:
      preview:
        pages: { route: string, structure: any }[]
        dataModels: { name: string, fields: any[] }[]
        apis: { endpoint: string, method: string }[]
    desc: 获取规格预览（用于用户确认）

# ============================================================
# 知识库 ⭐
# ============================================================
knowledge:

  matchTemplate:
    method: query
    auth: internal
    input:
      requirement: string
      type?: ProjectType
    output:
      result: TemplateMatchResult
    desc: 匹配最相似的模板

  getTemplate:
    method: query
    auth: internal
    input:
      templateId: string
    output:
      template: ProjectTemplate

  listTemplates:
    method: query
    auth: internal
    input:
      type?: ProjectType
      limit?: number = 10
    output:
      templates: ProjectTemplate[]

  getModule:
    method: query
    auth: internal
    input:
      moduleId: string
    output:
      module: FunctionModule

  listModules:
    method: query
    auth: internal
    input:
      category?: string
      limit?: number = 20
    output:
      modules: FunctionModule[]

  # 内部API - 积累
  saveProjectSpecs:
    method: mutation
    auth: internal
    input:
      projectId: string
      specs: ProjectSpec
      quality: { satisfaction: number, reworkCount: number }
    output:
      saved: boolean
    desc: 保存项目规格到知识库

  extractLearnings:
    method: mutation
    auth: internal
    input:
      discussionId: string
    output:
      learnings: ExpertLearning[]
    desc: 从专家讨论中提取经验

# ============================================================
# 提示词系统 API
# ============================================================

prompts:
  
  # 提示词管理
  list:
    method: query
    auth: internal
    input:
      stage?: string
    output:
      prompts: Array<{ id: string, name: string, version: string, status: string }>
    desc: 列出所有提示词

  get:
    method: query
    auth: internal
    input:
      promptId: string
    output:
      prompt: PromptTemplate
      versions: PromptVersion[]
    desc: 获取提示词详情

  getVersion:
    method: query
    auth: internal
    input:
      promptId: string
      version: string
    output:
      content: string
      config: { model: string, temperature: number, maxTokens: number }
    desc: 获取指定版本内容

  # 版本管理
  createVersion:
    method: mutation
    auth: internal
    input:
      promptId: string
      content: string
      config: { model: string, temperature: number, maxTokens: number }
    output:
      version: PromptVersion
    desc: 创建新版本

  publish:
    method: mutation
    auth: internal
    input:
      promptId: string
      version: string
    output:
      success: boolean
    desc: 发布版本到生产

  rollback:
    method: mutation
    auth: internal
    input:
      promptId: string
      toVersion?: string
    output:
      success: boolean
      rolledBackTo: string
    desc: 回滚到上一稳定版本

  # A/B测试
  createABTest:
    method: mutation
    auth: internal
    input:
      promptId: string
      versionB: string
      trafficSplit?: number = 0.1
    output:
      test: PromptABTest
    desc: 创建A/B测试

  stopABTest:
    method: mutation
    auth: internal
    input:
      testId: string
    output:
      result: { winner: string, confidence: number }
    desc: 停止A/B测试

  # 指标和分析
  getMetrics:
    method: query
    auth: internal
    input:
      promptId: string
    output:
      metrics: PromptMetrics
    desc: 获取提示词指标

  getFailures:
    method: query
    auth: internal
    input:
      promptId: string
      limit?: number = 10
    output:
      failures: PromptExecution[]
    desc: 获取失败记录

  # 审核和优化
  triggerReview:
    method: mutation
    auth: internal
    input:
      promptId: string
      version: string
    output:
      result: PromptReviewResult
    desc: 触发多Agent审核

  triggerOptimization:
    method: mutation
    auth: internal
    input:
      promptId: string
    output:
      optimization: { newVersion: string, changes: string[] }
    desc: 触发自动优化

  # 执行记录
  recordExecution:
    method: mutation
    auth: internal
    input:
      execution: PromptExecution
    output:
      recorded: boolean
    desc: 记录提示词执行结果
