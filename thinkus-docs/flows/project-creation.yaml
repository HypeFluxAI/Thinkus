# ============================================================
# 项目创建流程
# ============================================================

meta:
  name: project-creation
  description: 从用户输入到开发完成的完整流程

# ============================================================
# 状态机
# ============================================================
states:

  START:
    desc: 用户进入创建页
    next: CHATTING
    actions: [创建空项目, 初始化对话]

  CHATTING:
    desc: 用户与AI对话
    next:
      DISCUSSING: 用户确认描述完成
      CHATTING: 继续对话
    actions: [保存对话, 实时识别功能, 实时估价]

  DISCUSSING:
    desc: 专家讨论中
    next:
      PENDING_CONFIRM: 讨论完成
      CHATTING: 用户要求重新描述
    actions: [选择专家, 执行讨论, 生成方案]

  PENDING_CONFIRM:
    desc: 等待用户确认
    next:
      PENDING_PAYMENT: 用户确认
      DISCUSSING: 用户要求修改
    actions: [显示方案, 显示价格]

  PENDING_PAYMENT:
    desc: 等待支付
    next:
      IN_PROGRESS: 支付成功
      PENDING_CONFIRM: 支付取消
    actions: [创建支付意向, 处理支付]

  IN_PROGRESS:
    desc: 开发中
    next:
      COMPLETED: 开发完成
    actions: [启动Agent, 更新进度, 发送日志]

  COMPLETED:
    desc: 开发完成
    actions: [发送通知, 展示庆祝页]

# ============================================================
# 步骤详情
# ============================================================
steps:

  # Step 1: 对话
  chat:
    page: /create
    user_actions:
      - 输入产品描述
      - 上传参考资料
      - 使用快速模板
      - 确认描述完成
    system_actions:
      - model: claude-sonnet
        action: 分析输入，识别功能
        output: [功能列表, 项目类型, 复杂度, 价格预估]
    exit_criteria:
      - 描述长度 >= 50字
      - 识别出 >= 3个功能
      - 用户点击确认

  # Step 2: 讨论
  discuss:
    page: /create (modal)
    ref: flows/expert-discussion.yaml
    exit_criteria:
      - 所有专家确认
      - 或用户跳过

  # Step 3: 确认
  confirm:
    page: /create/confirm
    user_actions:
      - 查看功能列表
      - 调整可选功能
      - 查看价格明细
      - 确认方案
    api:
      - projects.confirm

  # Step 4: 支付
  payment:
    page: /create/payment
    api:
      - payments.createIntent
      - payments.confirm
    integration: Stripe

  # Step 5: 开发
  develop:
    page: /projects/{id}/progress
    agents: [pm, designer, developer, tester, deployer]
    parallel: true
    api:
      - progress.stream (SSE)

  # Step 6: 完成
  complete:
    page: /projects/{id}/complete
    actions:
      - 发送通知
      - 生成分享图
      - 记录统计
