# ============================================================
# åˆ›å»ºé¡¹ç›® - AIå¯¹è¯é¡µé¢ â­ æ ¸å¿ƒé¡µé¢
# route: /create
# ============================================================

meta:
  route: /create
  layout: dashboard-minimal
  auth: true
  title: åˆ›å»ºé¡¹ç›® - Thinkus

# ============================================================
# é¡µé¢ç»“æž„
# ============================================================
structure:
  type: split-panel
  left:
    width: 60%
    content: chat-area
  right:
    width: 40%
    content: preview-area
    background: gray-50

# ============================================================
# å¤´éƒ¨
# ============================================================
header:
  type: CreateHeader
  props:
    backLink: /dashboard
    backText: è¿”å›ž
    title: åˆ›å»ºæ–°é¡¹ç›®
    steps:
      - å¯¹è¯
      - ç¡®è®¤
      - æ”¯ä»˜
      - å¼€å‘
      - å®Œæˆ
    currentStep: 0

# ============================================================
# å·¦ä¾§ï¼šå¯¹è¯åŒº
# ============================================================
chat-area:

  # AIå¯¹è¯ç»„ä»¶
  chat:
    type: AIChat
    
    props:
      # AIå¤´åƒ
      aiAvatar:
        icon: ðŸ¤–
        name: å°T
        mood: greeting  # greeting|thinking|celebrating
      
      # æ¬¢è¿Žæ¶ˆæ¯
      welcomeMessage: |
        å—¨ï¼æˆ‘æ˜¯å°Tï¼Œä½ çš„AIäº§å“ç»ç† ðŸ‘‹
        
        å‘Šè¯‰æˆ‘ä½ æƒ³åšä»€ä¹ˆäº§å“ï¼Ÿå¯ä»¥åƒå’Œæœ‹å‹èŠå¤©ä¸€æ ·æè¿°ï¼Œæ¯”å¦‚ï¼š
        "æˆ‘æƒ³åšä¸€ä¸ªå® ç‰©ç¤¾äº¤Appï¼Œè®©å® ç‰©ä¸»äººå¯ä»¥åˆ†äº«ç…§ç‰‡ã€äº¤æµç»éªŒ"
      
      # è¾“å…¥æ¡†
      input:
        placeholder: æè¿°ä½ æƒ³åšçš„äº§å“...
        maxLength: 2000
        voiceInput: true
        fileAttach: true
        fileAccept: .png,.jpg,.pdf,.docx
      
      # å¿«é€Ÿæ¨¡æ¿
      templates:
        - icon: ðŸ›’
          label: ç”µå•†
          prompt: æˆ‘æƒ³åšä¸€ä¸ªç”µå•†ç½‘ç«™ï¼Œå¯ä»¥å±•ç¤ºå•†å“ã€è´­ç‰©è½¦ã€åœ¨çº¿æ”¯ä»˜...
        
        - icon: ðŸ“±
          label: ç¤¾äº¤App
          prompt: æˆ‘æƒ³åšä¸€ä¸ªç¤¾äº¤Appï¼Œç”¨æˆ·å¯ä»¥å‘åŠ¨æ€ã€å…³æ³¨ã€ç§ä¿¡...
        
        - icon: ðŸ“Š
          label: SaaSå·¥å…·
          prompt: æˆ‘æƒ³åšä¸€ä¸ªSaaSå·¥å…·ï¼Œå¸®åŠ©ç”¨æˆ·...
        
        - icon: ðŸŽ®
          label: å°æ¸¸æˆ
          prompt: æˆ‘æƒ³åšä¸€ä¸ªH5å°æ¸¸æˆï¼ŒçŽ©æ³•æ˜¯...
        
        - icon: â›“ï¸
          label: Web3
          prompt: æˆ‘æƒ³åšä¸€ä¸ªWeb3é¡¹ç›®ï¼ŒåŒ…æ‹¬NFT/DeFi...

    # æ¶ˆæ¯æ¸²æŸ“
    messageRender:
      user:
        align: right
        bgColor: primary-600
        textColor: white
        borderRadius: 2xl rounded-tr-sm
      
      assistant:
        align: left
        bgColor: gray-100
        textColor: gray-900
        borderRadius: 2xl rounded-tl-sm
        avatar: true

    # è¡Œä¸º
    behavior:
      onSend: |
        1. append user message to messages
        2. set aiTyping = true
        3. call chat.send({ projectId, content })
        4. append assistant message to messages
        5. update generated from response.generatedData
        6. set aiTyping = false
      
      onTemplateClick: |
        (template) => setInputValue(template.prompt)
      
      onFileAttach: |
        (files) => upload files and append to attachments

# ============================================================
# å³ä¾§ï¼šå®žæ—¶é¢„è§ˆåŒº
# ============================================================
preview-area:

  type: LivePreview
  className: p-6 overflow-y-auto

  sections:

    # é¡¹ç›®æ‘˜è¦å¡ç‰‡
    - id: summary
      type: ProjectSummaryCard
      showWhen: generated.name
      props:
        projectName: ${generated.name}
        projectType: ${generated.type}
        complexity: ${generated.complexity}
        estimatedPrice: ${generated.priceRange}
        estimatedTime: ${generated.timeRange}
      className: mb-6

    # åŠŸèƒ½æ¨¡å—ç½‘æ ¼
    - id: features
      type: FeatureGrid
      showWhen: generated.features.length > 0
      props:
        title: åŠŸèƒ½æ¨¡å—
        features: ${generated.features}
        editable: true
        onToggle: handleFeatureToggle
      className: mb-6

    # ä»·æ ¼å›¾è¡¨
    - id: price
      type: PriceChart
      showWhen: generated.totalPrice > 0
      props:
        base: ${generated.basePrice}
        additions: ${generated.additions}
        total: ${generated.totalPrice}
        comparison: ä¼ ç»Ÿå¼€å‘éœ€è¦ $${generated.traditionalPrice}
        chartType: donut
      className: mb-6

    # ç©ºçŠ¶æ€
    - id: empty
      type: EmptyState
      showWhen: "!generated.name"
      props:
        icon: ðŸ’¡
        title: å¼€å§‹å¯¹è¯
        description: å‘Šè¯‰æˆ‘ä½ æƒ³åšä»€ä¹ˆï¼Œæˆ‘ä¼šåœ¨è¿™é‡Œå±•ç¤ºç†è§£

  # åº•éƒ¨æŒ‰é’®
  footer:
    type: Button
    props:
      text: ç¡®è®¤æ–¹æ¡ˆå¹¶ç»§ç»­ â†’
      variant: warm
      size: lg
      fullWidth: true
      disabled: ${generated.features.length === 0}
    onClick: |
      router.push('/create/confirm')

# ============================================================
# çŠ¶æ€
# ============================================================
state:
  # é¡¹ç›®ID
  projectId: string | null
  
  # å¯¹è¯
  messages: Message[] = []
  inputValue: string = ''
  attachments: string[] = []
  aiTyping: boolean = false
  
  # AIç”Ÿæˆçš„æ•°æ®
  generated:
    name: string | null = null
    type: ProjectType | null = null
    complexity: Complexity | null = null
    features: Feature[] = []
    priceRange: string | null = null
    timeRange: string | null = null
    basePrice: number = 0
    additions: Addition[] = []
    totalPrice: number = 0
    traditionalPrice: number = 0

# ============================================================
# ç”Ÿå‘½å‘¨æœŸ
# ============================================================
lifecycle:

  onMount: |
    1. if no projectId in URL:
       - call projects.create({ requirement: '' })
       - set projectId from response
    2. else:
       - call chat.get({ projectId })
       - set messages from response
       - restore generated from last AI message

# ============================================================
# APIè°ƒç”¨
# ============================================================
api:

  createProject:
    endpoint: projects.create
    input: { requirement: '' }
    onSuccess: |
      setProjectId(response.project.id)
      setConversationId(response.conversationId)

  sendMessage:
    endpoint: chat.send
    input:
      projectId: ${projectId}
      content: ${inputValue}
      attachments: ${attachments}
    onSuccess: |
      appendMessage(response.userMessage)
      appendMessage(response.assistantMessage)
      updateGenerated(response.assistantMessage.generatedData)
      setInputValue('')

# ============================================================
# åŠŸèƒ½åˆ‡æ¢å¤„ç†
# ============================================================
handlers:

  handleFeatureToggle: |
    (featureId) => {
      const feature = generated.features.find(f => f.id === featureId)
      if (feature.optional) {
        feature.included = !feature.included
        recalculatePrice()
      }
    }

  recalculatePrice: |
    () => {
      const base = generated.basePrice
      const additionsTotal = generated.additions
        .filter(a => a.selected)
        .reduce((sum, a) => sum + a.price, 0)
      const featuresTotal = generated.features
        .filter(f => f.optional && f.included)
        .reduce((sum, f) => sum + f.price, 0)
      generated.totalPrice = base + additionsTotal + featuresTotal
    }
